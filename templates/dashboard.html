<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portfolio Analyzer</title>
    <link rel="stylesheet" href="/static/css/style.css">
</head>

<body class="crypto-theme">
    <header>
        <h1>üöÄ Portfolio Analyzer</h1>
        <p>Track your crypto portfolio in real time</p>
    </header>
    <main>
        <section id="portfolio-summary">
            <h2>Portfolio Summary</h2>
            <div id="portfolio-content" class="placeholder">Loading portfolio data...</div>
        </section>
        <section id="market-summary">
            <h2>ü§ñ AI Market Summary</h2>
            <div id="market-summary-content" class="placeholder">Loading AI market analysis...</div>
        </section>
        <section id="assets">
            <h2>Your Assets</h2>
            <div id="assets-content" class="placeholder">Loading assets...</div>
        </section>
        <section id="etf-comparison">
            <h2>ETF Comparison</h2>
            <div id="etf-content" class="placeholder">Loading ETF data...</div>
        </section>
        <section id="trends">
            <h2>Trends (Coming Soon)</h2>
            <div class="placeholder">Trend graphs for each asset will appear here.</div>
        </section>
    </main>
    <footer>
        <p>Made with FastAPI & Jinja2 | <span class="crypto">‚Çø</span> <span class="crypto">Œû</span> <span
                class="crypto">‚óé</span></p>
    </footer>
    <script>
        function formatROI(roi) {
            if (roi === null || roi === undefined) return '-';
            const val = Number(roi).toFixed(2);
            return (roi > 0 ? '+' : '') + val + '%';
        }
        async function loadPortfolio() {
            const portfolioDiv = document.getElementById('portfolio-content');
            const assetsDiv = document.getElementById('assets-content');
            try {
                const res = await fetch('/api/portfolio');
                const data = await res.json();
                const now = new Date().toLocaleString();
                if (!data.assets || data.assets.length === 0) {
                    portfolioDiv.innerHTML = `<b>Add money, man!</b><br><small>No assets found as of ${now}</small>`;
                    assetsDiv.innerHTML = `<b>No assets to display.</b>`;
                } else {
                    portfolioDiv.innerHTML = `<b>Total assets:</b> ${data.assets.length} <br><small>Last updated: ${now}</small>`;
                    let table = `<table class="portfolio-table">
                        <thead>
                            <tr>
                                <th>Asset</th>
                                <th>Free</th>
                                <th>Locked</th>
                                <th>Current Price</th>
                                <th>Cost Basis</th>
                                <th>ROI 24h</th>
                                <th>ROI 7d</th>
                                <th>ROI 28d</th>
                                <th>ROI 90d</th>
                            </tr>
                        </thead>
                        <tbody>`;
                    for (const a of data.assets) {
                        table += `<tr>
                            <td>${a.asset}</td>
                            <td>${a.free}</td>
                            <td>${a.locked}</td>
                            <td>${a.current_price !== undefined ? a.current_price.toFixed(4) : '-'}</td>
                            <td>${a.average_cost_basis !== undefined ? a.average_cost_basis.toFixed(4) : '-'}</td>
                            <td>${formatROI(a.roi && a.roi['24h'])}</td>
                            <td>${formatROI(a.roi && a.roi['7d'])}</td>
                            <td>${formatROI(a.roi && a.roi['28d'])}</td>
                            <td>${formatROI(a.roi && a.roi['90d'])}</td>
                        </tr>`;
                    }
                    table += `</tbody></table>`;
                    assetsDiv.innerHTML = table;
                }
            } catch (e) {
                portfolioDiv.innerHTML = `<b>Error loading portfolio.</b>`;
                assetsDiv.innerHTML = '';
            }
        }
        async function loadETF() {
            const etfDiv = document.getElementById('etf-content');
            try {
                const res = await fetch('/api/etf-comparison');
                const data = await res.json();
                let html = `<b>ETF Allocation:</b> <br>`;
                html += Object.entries(data.etf_allocation).map(([k, v]) => `${k}: ${(v * 100).toFixed(1)}%`).join(' | ');
                html += `<br><b>ETF Value Now:</b> $${data.etf_value_now.toFixed(2)} (Initial: $${data.initial_investment})`;
                html += `<br><b>ETF ROI:</b> 24h: ${formatROI(data.etf_roi['24h'])} | 7d: ${formatROI(data.etf_roi['7d'])} | 28d: ${formatROI(data.etf_roi['28d'])} | 90d: ${formatROI(data.etf_roi['90d'])}`;
                html += `<br><br><table class="portfolio-table">
                    <thead>
                        <tr>
                            <th>Asset</th>
                            <th>Weight</th>
                            <th>Current Price</th>
                            <th>ROI 24h</th>
                            <th>ROI 7d</th>
                            <th>ROI 28d</th>
                            <th>ROI 90d</th>
                        </tr>
                    </thead>
                    <tbody>`;
                for (const a of data.assets) {
                    html += `<tr>
                        <td>${a.asset}</td>
                        <td>${(a.weight * 100).toFixed(1)}%</td>
                        <td>${a.current_price !== undefined ? a.current_price.toFixed(4) : '-'}</td>
                        <td>${formatROI(a.roi && a.roi['24h'])}</td>
                        <td>${formatROI(a.roi && a.roi['7d'])}</td>
                        <td>${formatROI(a.roi && a.roi['28d'])}</td>
                        <td>${formatROI(a.roi && a.roi['90d'])}</td>
                    </tr>`;
                }
                html += `</tbody></table>`;
                etfDiv.innerHTML = html;
            } catch (e) {
                etfDiv.innerHTML = `<b>Error loading ETF data.</b>`;
            }
        }
        async function loadMarketSummary() {
            const marketSummaryDiv = document.getElementById('market-summary-content');
            try {
                // Get portfolio symbols from the portfolio data
                const portfolioRes = await fetch('/api/portfolio');
                const portfolioData = await portfolioRes.json();
                const symbols = portfolioData.assets ? portfolioData.assets.map(a => a.asset) : ['BTC', 'ETH'];
                
                // Call the market summary endpoint with POST
                const res = await fetch('/portfolio/market_summary', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        symbols: symbols,
                        limit: 5
                    })
                });
                const data = await res.json();
                
                let html = `<div class="market-summary-card">`;
                html += `<div class="summary-section">`;
                html += `<h3>üìä Market Analysis</h3>`;
                html += `<p>${data.summary || 'No summary available'}</p>`;
                html += `</div>`;
                
                html += `<div class="actions-section">`;
                html += `<h3>üí° Recommended Actions</h3>`;
                html += `<p>${data.recommended_actions || 'No recommendations available'}</p>`;
                html += `</div>`;
                
                html += `<div class="news-section">`;
                html += `<h3>üì∞ Latest News for Your Portfolio</h3>`;
                if (data.news && data.news.length > 0) {
                    html += `<ul class="news-list">`;
                    data.news.forEach(item => {
                        html += `<li class="news-item">`;
                        html += `<strong>${item.title}</strong> (${item.crypto_topic})<br>`;
                        html += `<small>${item.chunk_text.substring(0, 100)}...</small>`;
                        html += `</li>`;
                    });
                    html += `</ul>`;
                } else {
                    html += `<p>No recent news found for your portfolio.</p>`;
                }
                html += `</div>`;
                html += `</div>`;
                
                marketSummaryDiv.innerHTML = html;
            } catch (e) {
                marketSummaryDiv.innerHTML = `<div class="error">‚ùå Error loading market summary: ${e.message}</div>`;
            }
        }
        window.onload = function () {
            loadPortfolio();
            loadETF();
            loadMarketSummary();
        };
    </script>
</body>

</html>
